# GitLab CI/CD Pipeline pour Symfony API
# Stages: build, quality, test, deploy

stages:
  - build
  - quality
  - test
  - deploy

variables:
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"
  PHP_VERSION: "8.4"
  # Optimisations Git pour éviter les timeouts
  GIT_DEPTH: "10"
  GIT_STRATEGY: "fetch"
  GIT_SUBMODULE_STRATEGY: "none"
  GIT_SSL_NO_VERIFY: "false"
  GIT_HTTP_LOW_SPEED_LIMIT: "1000"
  GIT_HTTP_LOW_SPEED_TIME: "300"

# Cache Composer pour accélérer les builds
cache:
  key: "${CI_COMMIT_REF_SLUG}-composer"
  paths:
    - .composer-cache/
    - vendor/

# =====================================
# Stage: Build
# =====================================
build:dependencies:
  stage: build
  image: php:8.4-cli-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 30m
  before_script:
    - apk add --no-cache postgresql-dev icu-dev $PHPIZE_DEPS
    - docker-php-ext-install pdo_pgsql intl
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - composer install --prefer-dist --no-progress --no-interaction --no-scripts
    - composer dump-autoload --optimize
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour
  only:
    - main

# =====================================
# Stage: Quality
# =====================================
phpstan:
  stage: quality
  image: php:8.4-cli-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 15m
  dependencies:
    - build:dependencies
  before_script:
    - apk add --no-cache postgresql-dev icu-dev $PHPIZE_DEPS
    - docker-php-ext-install pdo_pgsql intl
    - APP_ENV=test php bin/console cache:clear
    - APP_ENV=test php bin/console cache:warmup
  script:
    - vendor/bin/phpstan analyse src --level=max --memory-limit=1G --no-progress
  allow_failure: false
  only:
    - develop
    - main
    - merge_requests

php-cs-fixer:
  stage: quality
  image: php:8.4-cli-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 15m
  dependencies:
    - build:dependencies
  script:
    - vendor/bin/php-cs-fixer fix src --dry-run --diff --verbose
  allow_failure: false
  only:
    - main

# =====================================
# Stage: Test
# =====================================
phpunit:
  stage: test
  image: php:8.4-cli-alpine
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 20m
  services:
    - postgres:16-alpine
  variables:
    POSTGRES_DB: tcgcard_test
    POSTGRES_USER: tcgcard
    POSTGRES_PASSWORD: tcgcard_test_password
    DATABASE_URL: "postgresql://tcgcard:tcgcard_test_password@postgres:5432/tcgcard_test?serverVersion=16&charset=utf8"
    APP_ENV: test
  dependencies:
    - build:dependencies
  before_script:
    - apk add --no-cache postgresql-dev icu-dev
    - docker-php-ext-install pdo_pgsql intl
  script:
    - php bin/console doctrine:database:create --env=test --if-not-exists
    - php bin/console doctrine:migrations:migrate --env=test --no-interaction
    - vendor/bin/phpunit --coverage-text --colors=never
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  only:
    - main

# =====================================
# Stage: Deploy to Railway
# =====================================
deploy:production:
  stage: deploy
  image: alpine:latest
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 30m
  before_script:
    - apk add --no-cache curl bash
    # Installation de Railway CLI
    - curl -fsSL https://railway.app/install.sh | sh
    - export PATH="/root/.railway/bin:$PATH"
  script:
    - echo "Déploiement sur Railway..."
    - railway link $RAILWAY_PROJECT_ID
    - railway up --detach
  environment:
    name: production
    url: https://your-api-domain.railway.app
  only:
    - main
  when: manual

deploy:staging:
  stage: deploy
  image: alpine:latest
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 30m
  before_script:
    - apk add --no-cache curl bash
    - curl -fsSL https://railway.app/install.sh | sh
    - export PATH="/root/.railway/bin:$PATH"
  script:
    - echo "Déploiement sur Railway (staging)..."
    - railway link $RAILWAY_STAGING_PROJECT_ID
    - railway up --detach
  environment:
    name: staging
    url: https://your-api-staging.railway.app
  only:
    - develop
  when: manual
